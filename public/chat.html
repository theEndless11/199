<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <script src="https://cdn.ably.io/lib/ably.min.js"></script>
</head>
    <body>
<div id="chatbox-container">
    <div id="three-dots-menu">...</div> <!-- 3 dot icon -->

    <div id="chatbox">
        <div id="messages-container">
            <!-- Messages will be dynamically added here -->
        </div>

        <div id="message-input">
            <input type="text" id="user-message" placeholder="Type a message..." onkeyup="handleKey(event)">
            <!-- Photo picker button -->
            <input type="file" id="file-input" accept="image/*" onchange="previewPhoto()" style="display: none;" />
            <div class="icon-container" title="Pick a photo" onclick="document.getElementById('file-input').click()">
                <div class="cloudflare-icon"></div>
            </div>

            <!-- Image preview -->
            <img id="image-preview" class="image-preview" style="display: none;" />

            <!-- Send button -->
            <button onclick="sendMessage()">Send</button>

            <!-- Error message -->
            <p id="error-message" style="color: red; display: none;">Please type a message or select an image</p>
        </div>
    </div>

    <!-- Options menu -->
    <div id="options-menu">
        <a href="#" id="shareOption">Share</a>
        <a href="#" id="clearChatOption">Clear Chat</a>
        <a href="#" id="changeThemeOption">Change Theme</a>
    </div>
</div>

<script>
    const threeDotsMenu = document.getElementById('three-dots-menu');
    const optionsMenu = document.getElementById('options-menu');

    // Show the options menu when the 3 dots menu is clicked
    threeDotsMenu.addEventListener('click', () => {
        const isMenuVisible = optionsMenu.style.display === 'block';
        optionsMenu.style.display = isMenuVisible ? 'none' : 'block';
    });

    // Add functionality for each option
    document.getElementById('shareOption').addEventListener('click', (e) => {
        e.preventDefault();
        alert("Share option clicked!");
    });

    document.getElementById('clearChatOption').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('messages-container').innerHTML = ''; // Clears the chat
        alert("Chat cleared!");
    });

    document.getElementById('changeThemeOption').addEventListener('click', (e) => {
        e.preventDefault();
        document.body.style.backgroundColor = (document.body.style.backgroundColor === 'lightgray') ? 'white' : 'lightgray';
    });
</script>
<script>
// Function to preview selected photo
function previewPhoto() {
    const fileInput = document.getElementById('file-input');
    const imagePreview = document.getElementById('image-preview');

    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block'; // Show image preview
        };
        reader.readAsDataURL(file); // Read file as Data URL
    } else {
        imagePreview.style.display = 'none'; // Hide image preview if no file is selected
    }
}

// Function to handle key event (Enter key sends the message)
function handleKey(event) {
    if (event.key === "Enter") {
        sendMessage();
    }
}

</script>
    <style>
        /* 3 Dot Menu Style */
        #three-dots-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 24px;
            color: #333;
            z-index: 10;
        }

        #three-dots-menu:hover {
            color: #007bff;
        }
         button {
            padding: 10px;
            cursor: pointer;
        }

        #options-menu {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #options-menu a {
            display: block;
            margin: 10px 0;
            color: #333;
            text-decoration: none;
        }

        #options-menu a:hover {
            color: #007bff;
        }

        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Chatbox Container */
       #chatbox-container {
    background-color: #ffffff;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 400px;
    height: calc(100vh - 80px); /* Adjust height to allow space for the message input */
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

        /* Chatbox */
    #chatbox {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 15px;
    position: relative;
    overflow-y: auto;
    margin-bottom: 50px;  /* Add margin to create space for the fixed input */
}

/* Messages Container */
#messages-container {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

        /* Message Container */
        .message {
            display: flex;
            margin-bottom: 10px;
        }

        /* Aligning sender's message to the right */
        .user-msg {
            justify-content: flex-end;
        }

        /* Aligning receiver's message to the left */
        .other-msg {
            justify-content: flex-start;
        }

        /* Message Bubble Styling */
        .msg-bubble {
            display: inline-block;
            padding: 10px;
            border-radius: 12px;
            background-color: #f1f1f1;
            max-width: 70%;
            word-wrap: break-word;
        }

        /* Custom styling for sender's messages */
        .user-msg .msg-bubble {
            background-color: #4CAF50;
            color: white;
            border-bottom-right-radius: 5px;
        }

        /* Custom styling for receiver's messages */
        .other-msg .msg-bubble {
            background-color: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        /* Styling for images inside messages */
      /* Styling for images inside messages */
.msg-bubble img {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    display: block;
    object-fit: contain;  /* Ensures the image is not stretched */
}

/* Mobile-specific adjustments */
@media screen and (max-width: 480px) {
    .msg-bubble img {
        max-width: 80%;  /* Limit the image size on mobile */
        max-height: 200px; /* Add a max height to prevent large images */
        object-fit: contain;  /* Prevent stretching */
    }
}


        /* Styling for the timestamp */
        .timestamp {
            font-size: 0.75em;
            color: #888;
            margin-top: 5px;
            text-align: right;
        }

        /* Animations */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Message Input Area */
       #message-input {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background-color: #f9f9f9;
    border-top: 1px solid #eee;
    position: fixed;      /* Fixed position */
    bottom: 10px;         /* 10px from the bottom */
    left: 0;              /* Stick to the left edge */
    right: 0;             /* Stick to the right edge */
    flex-shrink: 0;
    z-index: 100;         /* Ensure it's above other content */
}

        #user-message {
            width: 65%;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-size: 14px;
            outline: none;
        }

        #user-message:focus {
            border-color: #4CAF50;
        }

        /* Preview for the selected image */
        #image-preview {
            display: none;
            max-width: 100px;
            max-height: 100px;
            border-radius: 10px;
            margin-left: 10px;
        }

        /* Photo Picker Icon */
        .icon-container {
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: #4CAF50;
            border-radius: 50%;
        }

        .cloudflare-icon {
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #45a049;
        }

        /* Responsive Design */
        @media screen and (max-width: 480px) {
            #chatbox-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }

            .msg-bubble {
                max-width: 90%;
            }

            #message-input {
                padding: 8px;
            }

            #user-message {
                width: 70%;
            }

            button {
                padding: 8px 15px;
            }
        }
    </style>

<script>
// Get userId and chatWith from query parameters
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('userId');
const chatWith = urlParams.get('chatWith');

// Log the query parameters to check if they are correctly passed
if (userId && chatWith) {
    console.log('userId:', userId, 'chatWith:', chatWith);
} else {
    alert('Missing userId or chatWith in the URL parameters');
    window.location.href = '/'; // Redirect to homepage or login
}

// Ably API Key
const ablyApiKey = 'z-PJnQ.-j8d2A:2MPSxeZ_Vfj487pTV11np4OE5yDTAZiln1a5IXWNj34';

// Initialize Ably connection directly using API key
const ably = new Ably.Realtime(ablyApiKey);

// Determine the correct channel name based on the userId and chatWith
const userChannel = `chat-${userId}-${chatWith}`;  // Sender's channel
const otherUserChannel = `chat-${chatWith}-${userId}`;  // Receiver's channel

console.log('User Channel:', userChannel, 'Other User Channel:', otherUserChannel);

// Subscribe to the current user's channel
const channel = ably.channels.get(userChannel);

// Listen for new messages on the current user's channel (Sender's Channel)
channel.subscribe('newMessage', function (message) {
    console.log('Real-time new message received on channel:', userChannel);
    console.log('Received message:', message.data); // Log the received message

    // Ensure the message is only displayed for the receiver, not the sender
    if (message.data.userId !== parseInt(userId)) {
        addMessageToChat(message.data);  // Add the new message to the chat UI
    }
});

// Function to fetch messages from the server and update the chat
function fetchMessagesAndUpdateChat() {
    fetch(`/api/messages?userId=${userId}&chatWith=${chatWith}`)
    .then(response => response.json())
    .then(data => {
        if (data.messages && Array.isArray(data.messages)) {
            // Only display valid messages
            const validMessages = data.messages.filter(msg => 
                msg && (msg.message || msg.photo) && msg.timestamp
            );
            if (validMessages.length > 0) {
                displayMessages(validMessages);
            } else {
                console.warn('No valid messages found.');
            }
        } else {
            console.error('Invalid message data received:', data);
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
}

// Function to display messages from the response
function displayMessages(messages) {
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = '';  // Clear previous messages
    
    messages.forEach(msg => {
        if (msg && (msg.message || msg.photo) && msg.timestamp) {
            // Create message elements
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('msg-bubble');
            
            // Check if it's a text message
            if (msg.message) {
                messageBubble.textContent = msg.message;
            }
            // Check if it's a photo message
            else if (msg.photo) {
                const imgElement = document.createElement('img');
                imgElement.src = msg.photo;  // Use the URL from the backend
                imgElement.alt = "User's photo";
                imgElement.style.maxWidth = '200px';  // Optionally control image size
                imgElement.style.maxHeight = '200px';
                messageBubble.appendChild(imgElement);
            }

            // Add timestamp
            const timestamp = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const timeElement = document.createElement('div');
            timeElement.classList.add('timestamp');
            timeElement.textContent = timestamp;

            // Check message sender
            if (msg.userId === parseInt(userId)) {
                messageElement.classList.add('user-msg');
            } else {
                messageElement.classList.add('other-msg');
            }

            messageElement.appendChild(messageBubble);
            messageElement.appendChild(timeElement);
            messagesContainer.appendChild(messageElement);
        }
    });
}

// Call the initial fetch for messages as soon as the page loads
document.addEventListener('DOMContentLoaded', () => {
    fetchMessagesAndUpdateChat();  // Initial fetch when the page loads
    pollForNewMessages();  // Start polling every 3 seconds
});

// Function to start polling for new messages
function pollForNewMessages() {
    setInterval(() => {
        fetchMessagesAndUpdateChat();
    }, 3000);  // 3000ms = 3 seconds
}


// Function to resize the image to a maximum size and ensure it's below 65KB
function resizeImageToMaxSize(imageSrc, maxSizeKB = 65) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = imageSrc;

        img.onload = function () {
            console.log("Image loaded successfully");

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Resize image to fit a max width of 200px (you can adjust this if needed)
            const maxWidth = 200;  // Maximum width in pixels
            const scale = maxWidth / img.width;  // Calculate scaling factor
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            // Draw the image on the canvas with the new dimensions
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // Function to check size after converting to Blob
            function checkSizeAndResolve(blob) {
                const sizeKB = blob.size / 1024;  // Size in KB
                console.log(`Compressed image size: ${sizeKB} KB`);

                if (sizeKB <= maxSizeKB) {
                    resolve(blob);  // If under 65KB, resolve with the Blob
                } else {
                    console.log("Image exceeds max size, rejecting...");
                    reject("Image is too large after resizing.");
                }
            }

            // Try converting to WebP (if supported)
            if (canvas.toBlob) {
                console.log("Converting to WebP...");
                canvas.toBlob((blob) => {
                    checkSizeAndResolve(blob);
                }, 'image/webp', 0.7);  // WebP with reduced quality
            } else {
                console.log("Canvas.toBlob() not supported.");
                reject("Canvas API not supported.");
            }
        };

        img.onerror = function (error) {
            console.error('Error loading image:', error);  // Reject if image loading fails
            reject("Error loading image: " + error);
        };
    });
}

// Function to upload photo as Blob
function sendPhotoBlob(blob) {
    const formData = new FormData();
    formData.append('photo', blob, 'photo.webp');  // Append the Blob to the form data

    // Upload the Blob to the server
    fetch('/api/upload', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.photoUrl) {
            sendPhoto(data.photoUrl);  // Send the URL of the uploaded photo
        }
    })
    .catch(error => {
        console.error('Error uploading photo:', error);
    });
}

function addMessageToChat(messageData) {
    const messagesContainer = document.getElementById('messages-container');
    if (!messagesContainer) return;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message');

    const messageBubble = document.createElement('div');
    messageBubble.classList.add('msg-bubble');

    // Check if the message is text or photo
    if (messageData.message) {
        messageBubble.textContent = messageData.message; // Display text message
    } else if (messageData.photo) {
        const imgElement = document.createElement('img');

        // Resize the image and ensure it doesn't exceed 65KB
        resizeImageToMaxSize(messageData.photo, 65) // Ensure size is below 65KB
            .then((compressedImageBlob) => {
                // Create an object URL from the Blob to display the image
                const imageUrl = URL.createObjectURL(compressedImageBlob);
                imgElement.src = imageUrl;
                imgElement.alt = "User's photo";
                imgElement.style.maxWidth = '200px';  // Control image size
                imgElement.style.maxHeight = '200px';
                messageBubble.appendChild(imgElement);
            })
            .catch(error => {
                console.error('Error compressing image:', error);
            });
    }

    // Add timestamp to the message
    const timestamp = new Date(messageData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const timeElement = document.createElement('div');
    timeElement.classList.add('timestamp');
    timeElement.textContent = timestamp;

    // Append message bubble and time
    messageElement.appendChild(messageBubble);
    messageElement.appendChild(timeElement);

    // Append the new message to the container
    messagesContainer.appendChild(messageElement);

    // Allow the layout to update first, then scroll to the bottom
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;  // Scroll to the bottom
    }, 0); // Allow the browser to repaint before scrolling
}


// Function to handle photo upload and resizing
function pickPhoto() {
    const photoInput = document.createElement('input');
    photoInput.type = 'file';
    photoInput.accept = 'image/*';
    photoInput.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageSrc = e.target.result;
                resizeImageToMaxSize(imageSrc, 65)  // Resize the image before sending
                    .then(resizedImageSrc => {
                        // Send or display the resized image
                        sendPhoto(resizedImageSrc);
                    })
                    .catch(error => {
                        console.error('Error resizing image:', error);
                    });
            };
            reader.readAsDataURL(file);
        }
    };
    photoInput.click();
}

// Function to send photo
function sendPhoto(photoData) {
    const messageData = {
        userId: userId,
        chatWith: chatWith,
        photo: photoData,  // Send the photo data (resized image)
        messageType: 'photo',
        timestamp: new Date().toISOString(),
        message: ''  // Empty message for photo
    };

    addMessageToChat(messageData);  // Display the message in chat immediately
    sendToServer(messageData);  // Send the photo message to the server
}

// Function to send the photo message to the server
function sendToServer(messageData) {
    // Example to send the message to the backend (could be adjusted as needed)
    fetch('/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(messageData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Message sent successfully') {
            console.log('Message sent');
        } else {
            console.error('Error sending message:', data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
    });
}



// Function to send message to the server
function sendToServer(messageData) {
    // Debugging: log the messageData before processing
    console.log('Message Data being sent:', messageData);

    // If messageType is 'photo', ensure that 'message' field is empty (it should still be present)
    if (messageData.messageType === 'photo' && !messageData.message) {
        messageData.message = ''; // Set message to an empty string for photo messages
    }

    // Ensure that userId, chatWith, and either message or photo are present
    if (!messageData.userId || !messageData.chatWith || (!messageData.message && !messageData.photo)) {
        console.error('Missing required fields: userId, chatWith, message/photo');
        return;
    }

    // If sending a photo, ensure that photo is set
    if (messageData.messageType === 'photo' && !messageData.photo) {
        console.error('Photo data missing for photo message');
        return;
    }

    // Debugging: Log before sending the request
    console.log('Sending message to server:', messageData);

    fetch('/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(messageData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Message sent successfully') {
            // Publish the message to the receiver's channel
            const realTimeMessage = {
                userId: messageData.userId,
                chatWith: messageData.chatWith,
                message: messageData.message,  // Send message field (even if empty for photos)
                photo: messageData.photo,      // Send the actual photo data (base64 or URL)
                messageType: messageData.messageType,
                timestamp: new Date().toISOString()
            };

            const receiverChannel = ably.channels.get(`chat-${messageData.chatWith}-${messageData.userId}`);  // Fixed string interpolation with backticks
            receiverChannel.publish('newMessage', realTimeMessage);  // Publish to the receiver's channel
        } else {
            console.error('Error sending message:', data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message to backend:', error);
    });
}

// Function to send text or photo message
function sendMessage() {
    const messageInput = document.getElementById('user-message');
    const imagePreview = document.getElementById('image-preview');
    const fileInput = document.getElementById('file-input');

    const message = messageInput.value.trim();
    const image = imagePreview.src;

    let isMessageSent = false;  // Flag to track if message was sent

    // Prepare the message data object for both text and photo messages
    const messageData = {
        userId: userId,
        chatWith: chatWith,
        timestamp: new Date().toISOString(),
    };

    // Handle sending text message
    if (message) {
        messageData.message = message;
        messageData.messageType = 'text';
        addMessageToChat(messageData);  // Show message immediately in chat
        sendToServer(messageData);      // Send the text message to the server
        isMessageSent = true;
    }

    // Handle sending image (either from file input or image preview)
    if (fileInput.files.length > 0 || image) {
        const photoMessageData = {
            userId: userId,
            chatWith: chatWith,
            messageType: 'photo',
            timestamp: new Date().toISOString(),
        };

        // Handle sending image from file input or image preview
        if (fileInput.files.length > 0) {
            // Image selected through file input
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                photoMessageData.photo = e.target.result;  // Base64 string of the image
                photoMessageData.message = '';             // Empty message for photo
                addMessageToChat(photoMessageData);       // Display the photo in the chat
                sendToServer(photoMessageData);           // Send the photo message to the server
            };
            reader.readAsDataURL(file);  // Read the image as a base64 string
        } else if (image && image !== '') {
            // Image selected through image preview (no file selected)
            photoMessageData.photo = image;  // URL from image preview
            photoMessageData.message = '';   // Empty message for photo
            addMessageToChat(photoMessageData);  // Display the message in chat
            sendToServer(photoMessageData);     // Send the photo to the server
        }

        isMessageSent = true;
    }

    // Handle error message visibility (if no message or photo was sent)
    const errorMessage = document.getElementById('error-message');
    if (!isMessageSent) {
        errorMessage.style.display = 'block'; // Show error if no message or photo is sent
    } else {
        errorMessage.style.display = 'none'; // Hide error if something was sent
    }

    // Clear inputs if a message or photo was successfully sent
    if (isMessageSent) {
        messageInput.value = '';  // Clear text input
        imagePreview.style.display = 'none';  // Hide image preview after sending
        fileInput.value = '';  // Clear the file input
    }
}

// Call the function to load previous messages when the page is loaded
loadMessages();
</script>

