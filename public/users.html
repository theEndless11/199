<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Page</title>
</head>
<body>
    <!-- Logged-in user section -->
    <div id="logged-in-user">Loading logged-in user...</div>

    <!-- Users section -->
    <div id="users-container"></div>

    <script>
        // Get the logged-in user's ID from the query parameter or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId') || localStorage.getItem('userId'); // Fallback to localStorage if userId not in URL

        let loggedInUser = {};

        async function fetchLoggedInUser() {
            try {
                const response = await fetch(`/api/users/${userId}`); // Fetch specific user using /api/users/{userId}
                const data = await response.json();

                if (data.user) {
                    loggedInUser = data.user;
                    displayLoggedInUser();
                    fetchUsers(); // Fetch other users after displaying the logged-in user's info
                } else {
                    console.error('User data is missing:', data);
                    alert('User data not found');
                }
            } catch (error) {
                console.error('Error fetching logged-in user:', error);
                alert('Error fetching logged-in user. Please try again later.');
            }
        }

        // Display the logged-in user's username
        function displayLoggedInUser() {
            const loggedInUserContainer = document.getElementById('logged-in-user');
            if (loggedInUserContainer) { // Ensure the element exists before updating it
                loggedInUserContainer.textContent = `Logged in as: ${loggedInUser.username}`;
                console.log(`Displaying logged-in user: ${loggedInUser.username}`);
            } else {
                console.error('Element with id "logged-in-user" not found');
            }
        }

        // Fetch all users excluding the logged-in user
        async function fetchUsers() {
            const response = await fetch(`/api/users?userId=${userId}`); // Fetch all users excluding the logged-in user
            const data = await response.json();
            if (response.ok) {
                displayUsers(data.users);
            } else {
                console.error('Error fetching users:', data.message);
                alert(data.message);
            }
        }

        // Display users in the Users section
        function displayUsers(users) {
            const usersContainer = document.getElementById('users-container');
            usersContainer.innerHTML = ''; // Clear previous data

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.classList.add('user');
                userElement.textContent = user.username;

                const addButton = document.createElement('button');
                addButton.classList.add('add-friend');
                addButton.textContent = 'Add Friend';
                addButton.onclick = () => addFriend(user);

                userElement.appendChild(addButton);
                usersContainer.appendChild(userElement);
            });
        }

        // Add a user to the friends section
        function addFriend(user) {
            const friendContainer = document.getElementById('friends-container');
            const friendElement = document.createElement('div');
            friendElement.classList.add('friend');
            friendElement.textContent = user.username;
            friendContainer.appendChild(friendElement);
        }

        // Fetch logged-in user and all other users
        fetchLoggedInUser();
    </script>
</body>
</html>

